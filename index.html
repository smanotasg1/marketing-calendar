<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Marketing Calendar</title>
  <!-- LibrerÃ­as -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body, html { background-color: #1a1a1a; }
    #root { min-height: 100vh; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    // ðŸ”¥ TU CONFIG DE FIREBASE (no cambia)
    const firebaseConfig = {
      apiKey: "AIzaSyDDbdGShwSdidFWMd__mISqiX7Y8BCcVdA",
      authDomain: "marketing-calendar-f126f.firebaseapp.com",
      projectId: "marketing-calendar-f126f",
      storageBucket: "marketing-calendar-f126f.firebasestorage.app",
      messagingSenderId: "199471456003",
      appId: "1:199471456003:web:747296324223c771add336"
    };

    // Inicializa Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const calendarsRef = db.collection("calendars");

    const { useState, useEffect } = React;

    const App = () => {
      const [calendars, setCalendars] = useState([]);
      const [activeCalendar, setActiveCalendar] = useState(null);
      const [showCreateModal, setShowCreateModal] = useState(false);
      const [newCalendarName, setNewCalendarName] = useState("");
      const [editingCell, setEditingCell] = useState(null);
      const [editValue, setEditValue] = useState("");
      const [editingTime, setEditingTime] = useState(null);
      const [timeValue, setTimeValue] = useState("");

      // Cargar desde Firebase
      useEffect(() => {
        const unsubscribe = calendarsRef.onSnapshot(snapshot => {
          const data = snapshot.docs.map(doc => doc.data());
          if (data.length > 0) {
            setCalendars(data);
            setActiveCalendar(data[0]);
          } else {
            const defaultCal = createDefaultCalendar("Calendario Principal");
            setCalendars([defaultCal]);
            setActiveCalendar(defaultCal);
            calendarsRef.doc(defaultCal.id.toString()).set(defaultCal);
          }
        });

        return () => unsubscribe();
      }, []);

      // Guardar en Firebase
      useEffect(() => {
        if (calendars.length > 0) {
          calendars.forEach(cal => {
            calendarsRef.doc(cal.id.toString()).set(cal);
          });
        }
      }, [calendars]);

      const createDefaultCalendar = (name) => {
        const days = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"];
        const timeWindows = [
          "12:30 to 13:00",
          "14:30 to 15:00", 
          "15:00 to 15:30",
          "16:00 to 16:30",
          "16:30 to 17:00",
          "18:00 to 18:30",
          "18:30 to 19:00"
        ];

        return {
          id: Date.now(),
          name,
          days: [...days],
          timeWindows: [...timeWindows],
          labelNames: { platforms: "Platforms", contentTypes: "Content" },
          activities: timeWindows.map(timeWindow => ({
            timeWindow,
            tasks: days.map(day => ({
              day,
              task: "",
              subtask: "",
              details: "",
              platforms: [],
              contentTypes: []
            }))
          }))
        };
      };

      const handleEditCell = (activityIndex, dayIndex, field, value) => {
        const updatedCalendar = { ...activeCalendar };
        updatedCalendar.activities[activityIndex].tasks[dayIndex][field] = value;
        setCalendars(prev => prev.map(cal => 
          cal.id === activeCalendar.id ? updatedCalendar : cal
        ));
        setActiveCalendar(updatedCalendar);
      };

      const handleEditLabels = (activityIndex, dayIndex, labelType, label) => {
        const updatedCalendar = { ...activeCalendar };
        const task = updatedCalendar.activities[activityIndex].tasks[dayIndex];
        if (!task[labelType]) task[labelType] = [];
        const index = task[labelType].indexOf(label);
        if (index === -1) {
          task[labelType].push(label);
        } else {
          task[labelType].splice(index, 1);
        }
        setCalendars(prev => prev.map(cal => 
          cal.id === activeCalendar.id ? updatedCalendar : cal
        ));
        setActiveCalendar(updatedCalendar);
      };

      const handleEditTime = (activityIndex, value) => {
        const updatedCalendar = { ...activeCalendar };
        updatedCalendar.timeWindows[activityIndex] = value;
        updatedCalendar.activities[activityIndex].timeWindow = value;
        setCalendars(prev => prev.map(cal => 
          cal.id === activeCalendar.id ? updatedCalendar : cal
        ));
        setActiveCalendar(updatedCalendar);
      };

      const startEditing = (activityIndex, dayIndex, field, currentValue) => {
        setEditingCell({ activityIndex, dayIndex, field });
        setEditValue(currentValue || "");
      };

      const startEditingTime = (activityIndex, timeValue) => {
        setEditingTime(activityIndex);
        setTimeValue(timeValue || "");
      };

      const saveEdit = () => {
        if (editingCell && editValue !== "") {
          handleEditCell(editingCell.activityIndex, editingCell.dayIndex, editingCell.field, editValue);
          setEditingCell(null);
          setEditValue("");
        }
      };

      const saveTimeEdit = () => {
        if (editingTime !== null && timeValue.trim() !== "") {
          handleEditTime(editingTime, timeValue.trim());
          setEditingTime(null);
          setTimeValue("");
        }
      };

      const cancelEdit = () => {
        setEditingCell(null);
        setEditValue("");
      };

      const cancelTimeEdit = () => {
        setEditingTime(null);
        setTimeValue("");
      };

      const renderCellContent = (task, activityIndex, dayIndex, field) => {
        const isEditing = editingCell?.activityIndex === activityIndex && 
                          editingCell?.dayIndex === dayIndex && 
                          editingCell?.field === field;

        if (isEditing) {
          return (
            <div className="flex flex-col space-y-1 h-full">
              <textarea
                value={editValue}
                onChange={(e) => setEditValue(e.target.value)}
                autoFocus
                className="flex-1 p-1 text-sm border rounded focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none bg-white text-gray-900"
                rows={field === 'details' ? 3 : 1}
                style={{ minHeight: '20px' }}
              />
              <div className="flex space-x-1 pt-1">
                <button onClick={saveEdit} className="bg-green-500 text-white px-2 py-1 text-xs rounded hover:bg-green-600">Save</button>
                <button onClick={cancelEdit} className="bg-gray-500 text-white px-2 py-1 text-xs rounded hover:bg-gray-600">Cancel</button>
              </div>
            </div>
          );
        }

        const content = task[field] || "";
        if (!content) {
          return (
            <button
              onClick={() => startEditing(activityIndex, dayIndex, field, "")}
              className="w-full h-full flex items-center justify-center text-gray-400 hover:text-gray-600 text-sm"
            >
              +
            </button>
          );
        }

        return (
          <div 
            onClick={() => startEditing(activityIndex, dayIndex, field, content)}
            className="cursor-pointer p-1 min-h-[20px] h-full"
          >
            {field === 'details' ? (
              <pre className="text-xs whitespace-pre-wrap text-gray-700">{content}</pre>
            ) : (
              <span className="text-sm">{content}</span>
            )}
          </div>
        );
      };

      const renderTimeContent = (time, activityIndex) => {
        const isEditing = editingTime === activityIndex;

        if (isEditing) {
          return (
            <div className="flex flex-col space-y-1 h-full">
              <input
                type="text"
                value={timeValue}
                onChange={(e) => setTimeValue(e.target.value)}
                autoFocus
                placeholder="12:30 to 13:00"
                className="p-1 text-sm border rounded focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white text-gray-900"
              />
              <div className="flex space-x-1 pt-1">
                <button onClick={saveTimeEdit} className="bg-green-500 text-white px-2 py-1 text-xs rounded hover:bg-green-600">Save</button>
                <button onClick={cancelTimeEdit} className="bg-gray-500 text-white px-2 py-1 text-xs rounded hover:bg-gray-600">Cancel</button>
              </div>
            </div>
          );
        }

        return (
          <div 
            onClick={() => startEditingTime(activityIndex, time)}
            className="cursor-pointer p-2 min-h-[20px] h-full"
          >
            <span className="text-sm">{time}</span>
          </div>
        );
      };

      const renderLabels = (task, activityIndex, dayIndex, labelType, defaultName) => {
        const taskLabels = task[labelType] || [];
        const displayName = activeCalendar?.labelNames?.[labelType] || defaultName;
        
        return (
          <div className="flex flex-wrap gap-1 mt-1 pt-1 border-t">
            <div className="flex items-center w-full">
              <p className="text-xs font-semibold text-gray-600 mr-2">{displayName}:</p>
              <button
                onClick={() => {
                  const newLabel = prompt(`Nuevo ${displayName}:`);
                  if (newLabel) handleEditLabels(activityIndex, dayIndex, labelType, newLabel);
                }}
                className="text-xs px-2 py-1 rounded bg-gray-200 text-gray-700 hover:bg-gray-300 transition-colors"
              >
                +
              </button>
            </div>
            {taskLabels.map(label => (
              <button
                key={label}
                onClick={() => handleEditLabels(activityIndex, dayIndex, labelType, label)}
                className="text-xs px-2 py-1 rounded-full bg-blue-500 text-white hover:bg-blue-600 transition-colors"
              >
                {label}
              </button>
            ))}
          </div>
        );
      };

      if (!activeCalendar) return <p className="text-white p-8">Cargando...</p>;

      return (
        <div className="min-h-screen bg-gray-900 text-white">
          {/* Header */}
          <div className="bg-gradient-to-r from-indigo-900 to-purple-900 p-6">
            <div className="max-w-7xl mx-auto text-center">
              <h1 className="text-4xl font-bold mb-2">Marketing Calendar</h1>
              <p>âœ… Todos ven lo mismo</p>
            </div>
          </div>

          <div className="max-w-7xl mx-auto p-6">
            <div className="bg-white rounded-xl shadow-xl p-6 mb-8">
              <h2 className="text-3xl font-bold text-gray-800 mb-2">{activeCalendar.name}</h2>
              <p className="text-gray-600">
                {activeCalendar.timeWindows.length} time slots â€¢ {activeCalendar.days.length} days
              </p>
            </div>

            <div className="bg-white rounded-xl shadow-2xl overflow-hidden">
              <div className="overflow-x-auto">
                <table className="w-full table-fixed border-collapse">
                  <thead>
                    <tr>
                      <th className="bg-gradient-to-b from-gray-800 to-gray-700 text-white px-6 py-4 text-left min-w-56">
                        Time Window
                      </th>
                      {activeCalendar.days.map((day) => (
                        <th key={day} className="bg-gradient-to-b from-indigo-500 to-indigo-600 text-white px-6 py-4 text-center min-w-40">
                          {day}
                        </th>
                      ))}
                    </tr>
                  </thead>
                  <tbody>
                    {activeCalendar.activities.map((activity, activityIndex) => (
                      <tr key={activity.timeWindow} className="border-b border-gray-100 hover:bg-gray-50">
                        <td className="bg-gray-50 text-gray-800 px-6 py-4 text-left border-r border-gray-200">
                          {renderTimeContent(activity.timeWindow, activityIndex)}
                        </td>
                        {activity.tasks.map((task, dayIndex) => (
                          <td key={`${activityIndex}-${dayIndex}`} className="px-3 py-4 border-l border-gray-100">
                            <div className="bg-gray-50 rounded-lg p-3 min-h-28">
                              {task.task && (
                                <div className="flex items-start mb-1">
                                  <span className="bg-purple-500 text-white px-2 py-1 mr-2 rounded text-xs font-bold">|</span>
                                  <div className="text-sm font-semibold text-gray-800 flex-1">
                                    {renderCellContent(task, activityIndex, dayIndex, 'task')}
                                  </div>
                                </div>
                              )}
                              {!task.task && (
                                <div>{renderCellContent(task, activityIndex, dayIndex, 'task')}</div>
                              )}
                              
                              {task.subtask && (
                                <div className="flex items-start mb-1 ml-6">
                                  <span className="bg-green-500 text-white px-2 py-1 mr-2 rounded text-xs font-bold">|</span>
                                  <div className="text-sm text-gray-700 flex-1">
                                    {renderCellContent(task, activityIndex, dayIndex, 'subtask')}
                                  </div>
                                </div>
                              )}
                              
                              {task.details && (
                                <div className="text-xs text-gray-600 border-t pt-1 mt-1">
                                  {renderCellContent(task, activityIndex, dayIndex, 'details')}
                                </div>
                              )}
                              
                              {renderLabels(task, activityIndex, dayIndex, 'platforms', 'Platforms')}
                              {renderLabels(task, activityIndex, dayIndex, 'contentTypes', 'Content')}
                            </div>
                          </td>
                        ))}
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      );
    };

    const container = document.getElementById('root');
    const root = ReactDOM.createRoot(container);
    root.render(<App />);
  </script>
</body>
</html>
